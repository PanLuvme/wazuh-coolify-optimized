version: "3.8"

services:
  wazuh-indexer:
    build:
      context: ./indexer
      dockerfile: Dockerfile
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms1536m -Xmx1536m -XX:+UseG1GC"
      - "discovery.type=single-node"
      - "network.host=0.0.0.0"
      - "DISABLE_INSTALL_DEMO_CONFIG=true"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    mem_limit: 3g
    mem_reservation: 2g
    cpus: 2
    volumes:
      - wazuh-indexer-data:/var/lib/wazuh-indexer
    networks:
      - wazuh-net
    healthcheck:
      test: ["CMD-SHELL", "code=$(curl -sk -o /dev/null -w '%{http_code}' https://localhost:9200); [ \"$$code\" = \"200\" ] || [ \"$$code\" = \"401\" ] || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  wazuh-manager:
    build:
      context: ./manager
      dockerfile: Dockerfile
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    ports:
      - "1514:1514/tcp"
      - "1515:1515/tcp"
    environment:
      - "INDEXER_URL=${INDEXER_URL:-https://wazuh-indexer:9200}"
      - "INDEXER_USERNAME=${INDEXER_USERNAME:-admin}"
      - "INDEXER_PASSWORD=${INDEXER_PASSWORD:-admin}"
      - "FILEBEAT_SSL_VERIFICATION_MODE=${FILEBEAT_SSL_VERIFICATION_MODE:-none}"
    mem_limit: 2g
    mem_reservation: 1g
    cpus: 1.5
    volumes:
      - wazuh-manager-data:/var/ossec/data
      - wazuh-manager-logs:/var/ossec/logs
      - wazuh-manager-etc:/var/ossec/etc
      - wazuh-filebeat-data:/var/lib/filebeat
    depends_on:
      wazuh-indexer:
        condition: service_healthy
    networks:
      - wazuh-net
    healthcheck:
      test: ["CMD-SHELL", "pgrep -x wazuh-modulesd > /dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 15
      start_period: 180s

  wazuh-dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      - "INDEXER_URL=${INDEXER_URL:-https://wazuh-indexer:9200}"
      - "INDEXER_USERNAME=${INDEXER_USERNAME:-admin}"
      - "INDEXER_PASSWORD=${INDEXER_PASSWORD:-admin}"
      - "WAZUH_API_URL=${WAZUH_API_URL:-https://wazuh-manager:55000}"
      - "WAZUH_API_USERNAME=${WAZUH_API_USERNAME:-wazuh-wui}"
      - "WAZUH_API_PASSWORD=${WAZUH_API_PASSWORD:-wazuh-wui}"
      - "SERVER_HOST=0.0.0.0"
      - "SERVER_PORT=5601"
    mem_limit: 1.5g
    mem_reservation: 768m
    cpus: 1
    depends_on:
      wazuh-indexer:
        condition: service_healthy
      wazuh-manager:
        condition: service_healthy
    networks:
      - wazuh-net
    healthcheck:
      test: ["CMD-SHELL", "code=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:5601/api/status); [ \"$$code\" = \"200\" ] || [ \"$$code\" = \"302\" ] || [ \"$$code\" = \"401\" ] || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  wazuh-web:
    image: nginx:alpine
    restart: unless-stopped
    depends_on:
      wazuh-dashboard:
        condition: service_healthy
    networks:
      - wazuh-net
      - coolify
    healthcheck:
      test: ["CMD-SHELL", "wget -qSO- http://localhost/ 2>/dev/null | head -n 1 >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
    command: >
      /bin/sh -lc "cat >/etc/nginx/conf.d/default.conf <<'EOF'
      server {
        listen 80;
        location / {
          proxy_pass http://wazuh-dashboard:5601;
          proxy_set_header Host $$host;
          proxy_set_header X-Real-IP $$remote_addr;
          proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $$scheme;
        }
      }
      EOF
      && nginx -g 'daemon off;'"

volumes:
  wazuh-indexer-data:
  wazuh-manager-data:
  wazuh-manager-logs:
  wazuh-manager-etc:
  wazuh-filebeat-data:

networks:
  wazuh-net:
    driver: bridge
  coolify:
    external: true
    name: coolify
